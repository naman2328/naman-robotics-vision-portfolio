<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspection Simulator | Naman Sharma</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="index.html">Naman <span>Sharma</span></a>
      <nav class="nav-links" aria-label="Main navigation">
        <a class="nav-link" href="index.html">Home</a>
        <a class="nav-link" href="vision.html">Projects</a>
        <a class="nav-link" href="automation.html">Automation</a>
        <a class="nav-link active" href="simulator.html">Simulator</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section>
      <span class="badge">Interactive Demo</span>
      <h1><span class="gradient">Factory-style OCR inspection simulator</span></h1>
      <p class="lead">Grant camera access, position text inside the inspection box, and run a pass/fail check against the expected serial code.</p>
      <p class="note">Browser-only prototype for demonstration. For production use, OCR should run in a controlled edge compute environment.</p>
    </section>

    <section class="section sim-wrap">
      <article class="card">
        <h3>Live camera</h3>
        <div class="video-shell">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="overlay"></canvas>
        </div>
        <div class="actions">
          <button id="startCam" class="btn btn-secondary" type="button">Start camera</button>
          <button id="inspectBtn" class="btn btn-primary" type="button">Run inspection</button>
        </div>
      </article>

      <article class="card">
        <h3>Inspection setup</h3>
        <label for="expectedText">Expected text</label>
        <input id="expectedText" type="text" value="NMN-2026" class="input">
        <div class="kpi"><span>Result</span><span id="decision" class="meta">Waiting</span></div>
        <div class="kpi"><span>Detected</span><span id="detected" class="meta">-</span></div>
        <div class="kpi"><span>Similarity</span><span id="score" class="meta">-</span></div>
        <h3 class="mt-18">Logs</h3>
        <div id="logs" class="log-panel"></div>
      </article>
    </section>

    <p class="footer">Tip: keep text centered in the rectangle for better OCR confidence.</p>
  </main>

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const logs = document.getElementById('logs');
const decision = document.getElementById('decision');
const detected = document.getElementById('detected');
const scoreNode = document.getElementById('score');
const inspectBtn = document.getElementById('inspectBtn');
const startCamBtn = document.getElementById('startCam');
const expectedInput = document.getElementById('expectedText');

let roi = null;
let streamStarted = false;

function log(message) {
  const stamp = new Date().toLocaleTimeString();
  logs.innerHTML = `<div>[${stamp}] ${message}</div>` + logs.innerHTML;
}

function normalize(value) {
  return value.toUpperCase().replace(/[^A-Z0-9]/g, '');
}

function levenshtein(a, b) {
  const dp = Array.from({ length: a.length + 1 }, (_, i) => [i]);
  for (let j = 1; j <= b.length; j++) dp[0][j] = j;
  for (let i = 1; i <= a.length; i++) {
    for (let j = 1; j <= b.length; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
    }
  }
  return dp[a.length][b.length];
}

function similarity(a, b) {
  if (!a || !b) return 0;
  const distance = levenshtein(a, b);
  return Math.max(0, 1 - distance / Math.max(a.length, b.length));
}

function drawROI() {
  if (!video.videoWidth) return;
  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;
  const w = Math.floor(video.videoWidth * 0.62);
  const h = Math.floor(video.videoHeight * 0.26);
  const x = Math.floor((video.videoWidth - w) / 2);
  const y = Math.floor((video.videoHeight - h) / 2);
  roi = { x, y, w, h };

  ctx.clearRect(0, 0, overlay.width, overlay.height);
  ctx.lineWidth = 3;
  ctx.strokeStyle = '#58b8ff';
  ctx.strokeRect(x, y, w, h);
  ctx.fillStyle = 'rgba(0,0,0,0.22)';
  ctx.fillRect(0, 0, overlay.width, y);
  ctx.fillRect(0, y + h, overlay.width, overlay.height - (y + h));
  ctx.fillRect(0, y, x, h);
  ctx.fillRect(x + w, y, overlay.width - (x + w), h);
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    video.srcObject = stream;
    streamStarted = true;
    log('Camera started successfully.');
    video.addEventListener('loadedmetadata', drawROI, { once: true });
    window.addEventListener('resize', drawROI);
  } catch (error) {
    log(`Camera error: ${error.message}`);
    decision.textContent = 'Camera unavailable';
    decision.className = 'ng';
  }
}

async function runInspection() {
  if (!streamStarted) {
    log('Please start camera before inspection.');
    return;
  }
  drawROI();
  if (!roi || roi.w < 80 || roi.h < 50) {
    log('ROI too small to process.');
    return;
  }

  inspectBtn.disabled = true;
  inspectBtn.textContent = 'Processing...';
  log('Capturing ROI and running OCR...');

  try {
    const temp = document.createElement('canvas');
    temp.width = roi.w;
    temp.height = roi.h;
    const tctx = temp.getContext('2d');
    tctx.drawImage(video, roi.x, roi.y, roi.w, roi.h, 0, 0, roi.w, roi.h);

    const { data } = await Tesseract.recognize(temp, 'eng', { logger: () => {} });
    const raw = (data?.text || '').trim();
    const expected = normalize(expectedInput.value);
    const observed = normalize(raw);
    const sim = similarity(expected, observed);

    detected.textContent = raw || '(none)';
    scoreNode.textContent = `${Math.round(sim * 100)}%`;

    if (sim >= 0.7) {
      decision.textContent = 'PASS (OK)';
      decision.className = 'ok';
      log(`PASS: matched with ${Math.round(sim * 100)}% similarity.`);
    } else {
      decision.textContent = 'FAIL (NG)';
      decision.className = 'ng';
      log(`FAIL: expected ${expected || '-'}, got ${observed || '-'}.`);
    }
  } catch (error) {
    decision.textContent = 'Inspection error';
    decision.className = 'ng';
    log(`OCR runtime error: ${error.message}`);
  } finally {
    inspectBtn.disabled = false;
    inspectBtn.textContent = 'Run inspection';
  }
}

startCamBtn.addEventListener('click', startCamera);
inspectBtn.addEventListener('click', runInspection);
</script>
</body>
</html>
