<!DOCTYPE html>
<html>
<head>
  <title>Industrial Vision Simulator</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- OCR ENGINE (WEB ONLY) -->
  <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
</head>
<body>

<div class="container">

<span class="badge">INSPECTION SIMULATOR</span>
<h1>Industrial Vision Dashboard (Web Simulator)</h1>

<!-- ================= DISCLAIMER ================= -->
<div class="section card">
  <p style="color:#facc15; font-size:14px;">
    ⚠️ <b>Important:</b> This is a browser-based simulator created to demonstrate
    system workflow and inspection logic.
    The <b>actual production system</b> runs as a Qt application using
    PaddleOCR, barcode decoding, and industrial cameras.
    It just show that how does real application looklike.
  </p>
</div>

<!-- ================= CAMERA + STATUS ================= -->
<div class="section grid">

  <!-- CAMERA PANEL -->
  <div class="card">
    <h2>Camera Feed (Webcam)</h2>

    <div style="position:relative;">
      <video id="video" autoplay muted playsinline
             style="width:100%; border-radius:8px; background:#000;"></video>
      <canvas id="overlay"
              style="position:absolute; top:0; left:0;"></canvas>
    </div>

    <p style="color:var(--muted); margin-top:8px;">
      Click & drag to define ROI
    </p>
  </div>

  <!-- STATUS PANEL -->
  <div class="card">
    <h2>Inspection Status</h2>

    <p>System: <span id="systemStatus" class="ok">READY</span></p>
    <p>Detected Text: <span id="ocrText">---</span></p>
    <p>Result: <span id="resultText">---</span></p>
    <p>Confidence: <span id="confidence">---</span></p>
    <p>Cycle Time: <span id="cycleTime">---</span></p>

    <div style="margin-top:16px;">
      <button class="button" onclick="runOCR()">Single Capture</button>
    </div>
  </div>

</div>

<!-- ================= LOGS ================= -->
<div class="section card">
  <h2>System Logs</h2>
  <div id="logs"
       style="
         background:#0b1220;
         padding:12px;
         height:160px;
         overflow-y:auto;
         font-family:monospace;
         font-size:13px;
         border-radius:8px;
       ">
  </div>
</div>

<!-- ================= LOGIC EXPLANATION ================= -->
<div class="section card">
  <h2>Inspection Logic (Mirrored)</h2>
  <p style="color:var(--muted); max-width:900px;">
    OCR → Text normalization → Fuzzy matching → OK / NG decision →
    Confidence & timing → Logging.
    The same decision logic is used in the Qt-based production system,
    while the OCR engine differs for web compatibility.
  </p>
</div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ================= CONFIG ================= */

// Expected entries (demo)
const expectedEntries = ["ABC123", "LOT45"];

// Match threshold (similar to difflib)
const MATCH_THRESHOLD = 0.95;

/* ================= STATE ================= */
let roi = null;
let drawing = false;
let startX, startY;

/* ================= ELEMENTS ================= */
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");

const systemStatus = document.getElementById("systemStatus");
const ocrTextEl = document.getElementById("ocrText");
const resultText = document.getElementById("resultText");
const confidenceEl = document.getElementById("confidence");
const cycleTimeEl = document.getElementById("cycleTime");
const logs = document.getElementById("logs");

/* ================= CAMERA ================= */
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      log("Webcam stream started");
    };
  })
  .catch(() => alert("Camera access denied"));

/* ================= ROI DRAW ================= */
canvas.addEventListener("mousedown", e => {
  drawing = true;
  startX = e.offsetX;
  startY = e.offsetY;
});

canvas.addEventListener("mousemove", e => {
  if (!drawing) return;
  draw();
  drawRect(startX, startY, e.offsetX - startX, e.offsetY - startY, "#facc15");
});

canvas.addEventListener("mouseup", e => {
  drawing = false;
  roi = {
    x: Math.min(startX, e.offsetX),
    y: Math.min(startY, e.offsetY),
    w: Math.abs(e.offsetX - startX),
    h: Math.abs(e.offsetY - startY)
  };
  log("ROI defined");
  draw();
});

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (roi) drawRect(roi.x, roi.y, roi.w, roi.h, "#22c55e");
}

function drawRect(x, y, w, h, color) {
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.strokeRect(x, y, w, h);
}

/* ================= TEXT LOGIC ================= */
function normalize(text) {
  return text.toLowerCase().replace(/\s/g, "").replace(/[.,]/g, "");
}

function similarity(a, b) {
  let matches = 0;
  for (let i = 0; i < Math.min(a.length, b.length); i++) {
    if (a[i] === b[i]) matches++;
  }
  return matches / Math.max(a.length, b.length);
}

function isMatch(expected, detected) {
  const exp = normalize(expected);
  return detected.some(d =>
    similarity(exp, normalize(d)) >= MATCH_THRESHOLD
  );
}

/* ================= OCR ================= */
async function runOCR() {
  if (!roi) {
    alert("Define ROI first");
    return;
  }

  systemStatus.innerText = "PROCESSING";
  log("OCR cycle started");

  const t0 = performance.now();

  const temp = document.createElement("canvas");
  temp.width = roi.w;
  temp.height = roi.h;
  temp.getContext("2d").drawImage(
    video,
    roi.x, roi.y, roi.w, roi.h,
    0, 0, roi.w, roi.h
  );

  const result = await Tesseract.recognize(temp, "eng");
  const words = result.data.words.map(w => w.text).filter(Boolean);

  ocrTextEl.innerText = words.join(" | ") || "(no text)";
  confidenceEl.innerText = result.data.confidence.toFixed(1) + "%";

  const matched = expectedEntries.filter(e => isMatch(e, words));
  const status = matched.length === expectedEntries.length ? "OK" : "NG";

  resultText.innerText = status;
  resultText.className = status === "OK" ? "ok" : "fail";

  cycleTimeEl.innerText =
    ((performance.now() - t0) / 1000).toFixed(2) + " s";

  systemStatus.innerText = "READY";
  log(`OCR completed → ${status}`);
}

/* ================= LOGGING ================= */
function log(msg) {
  logs.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  logs.scrollTop = logs.scrollHeight;
}
</script>

</body>
</html>
